<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chemistry Separation Techniques Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 1);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .step-item {
            cursor: grab;
            transition: all 0.2s ease;
        }
        
        .step-item:active {
            cursor: grabbing;
            transform: scale(1.02);
        }

        .dragging {
            opacity: 0.5;
            background-color: #e2e8f0;
        }

        .drop-zone {
            min-height: 80px;
            border: 2px dashed #cbd5e1;
            border-radius: 0.75rem;
            transition: border-color 0.2s ease;
        }

        .drop-zone.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #mainContainer {
            min-height: 60vh;
        }

        .correct { border: 2px solid #22c55e !important; background-color: #f0fdf4 !important; }
        .incorrect { border: 2px solid #ef4444 !important; background-color: #fef2f2 !important; }
        
        .status-untested { background-color: #e2e8f0; color: #64748b; }
        .status-correct { background-color: #22c55e; color: white; }
        .status-incorrect { background-color: #ef4444; color: white; }

        .hint-box {
            border-left: 4px solid #f59e0b;
            background-color: #fffbeb;
        }

        #cheatsheetSidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }
        .sidebar-closed { transform: translateX(-100%); }
        .sidebar-open { transform: translateX(0); }

        .technique-accordion {
            transition: max-height 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
        }
        .technique-accordion.open {
            max-height: 600px;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Cheatsheet Sidebar -->
    <aside id="cheatsheetSidebar" class="fixed left-0 top-0 h-full w-80 bg-white shadow-2xl sidebar-closed border-r border-slate-200 flex flex-col">
        <div class="p-4 border-b border-slate-100 flex items-center bg-slate-50">
            <button onclick="toggleCheatsheet()" class="p-2 mr-3 rounded-full hover:bg-slate-200 text-slate-600 transition-colors" title="Close Hints">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </button>
            <h2 class="text-lg font-bold text-slate-800">Technique Hints</h2>
        </div>
        <div class="flex-grow overflow-y-auto p-4 space-y-2" id="cheatsheetContent">
            <!-- Populated by JS -->
        </div>
        <div class="p-4 bg-slate-50 border-t border-slate-100 text-[10px] text-slate-400 italic">
        </div>
    </aside>

    <div id="app" class="max-w-4xl mx-auto flex-grow relative">
        <!-- Sidebar Toggle Button -->
        <button id="sidebarToggle" onclick="toggleCheatsheet()" class="hidden fixed left-4 top-24 z-40 bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 transition-all flex items-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <span class="text-xs font-bold pr-1">Hints</span>
        </button>

        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">Separation Techniques Master</h1>
            <p class="text-slate-600">Secondary School Chemistry (IP1 Edition)</p>
            
            <div class="mt-6 flex justify-center items-center space-x-4">
                <span class="text-sm font-semibold text-slate-500">Study Mode</span>
                <button id="modeToggle" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 bg-slate-200">
                    <span id="toggleCircle" class="translate-x-0 pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                </button>
                <span class="text-sm font-semibold text-slate-500">Quiz Mode</span>
            </div>

            <!-- Score Display -->
            <div id="scoreHeader" class="hidden mt-4 flex flex-col items-center space-y-2">
                <div class="flex flex-wrap justify-center items-center gap-3">
                    <div id="standardScoreChip" class="bg-blue-600 text-white px-3 py-1 rounded-full text-[10px] md:text-xs font-bold opacity-30 transition-opacity duration-300">
                        Standard: <span id="currentStandardScore">0/8</span>
                    </div>
                    <div id="sequencingScoreChip" class="bg-purple-600 text-white px-3 py-1 rounded-full text-[10px] md:text-xs font-bold opacity-30 transition-opacity duration-300">
                        Sequencing: <span id="currentSequencingScore">0/8</span>
                    </div>
                    <div id="advancedScoreChip" class="bg-orange-600 text-white px-3 py-1 rounded-full text-[10px] md:text-xs font-bold opacity-30 transition-opacity duration-300">
                        Multi-Step: <span id="currentAdvancedScore">0/8</span>
                    </div>
                </div>
                <button onclick="resetAllProgress()" class="text-[10px] font-bold text-red-500 hover:text-red-700 underline uppercase tracking-widest mt-2">
                    Reset All Progress
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="mainContainer" class="fade-in">
            <!-- Content will be injected here -->
        </main>
    </div>

    <!-- Accreditation Footer -->
    <footer class="mt-12 mb-4 text-center text-slate-400 text-xs">
        Created by <span class="font-bold text-slate-500">James Kua</span>, Temasek Junior College
    </footer>

    <script>
        const techniques = {
            "magnetic_attraction": {
                name: "Magnetic Attraction",
                components: "Metallic solid (magnetic) from Non-metallic solid",
                removes: "Magnetic metallic solids (e.g., Iron)",
                steps: ["Place the mixture on a flat surface or in a shallow dish.", "Wrap a magnet in a plastic sheet to prevent particles sticking to it.", "Move the magnet over the mixture.", "The magnetic substance is attracted to the magnet, leaving the non-magnetic solid behind."]
            },
            "filtration": {
                name: "Filtration",
                components: "Insoluble solid from Liquid",
                removes: "Insoluble solids (Residue)",
                steps: ["Fold a piece of filter paper into a cone shape.", "Place the paper inside a filter funnel.", "Pour the mixture into the funnel over a beaker.", "The residue stays on the paper; the filtrate passes through."]
            },
            "evaporation": {
                name: "Evaporation to Dryness",
                components: "Soluble solid (heat stable) from Liquid",
                removes: "Solvent (to recover dry Solute)",
                steps: ["Pour the solution into an evaporating dish.", "Heat the dish until all solvent evaporates.", "The solid solute remains in the dish as a dry powder."]
            },
            "sublimation": {
                name: "Sublimation",
                components: "Sublimable solid from Non-sublimable solid",
                removes: "Sublimable solids (e.g., Iodine, Ammonium Chloride)",
                steps: ["Place mixture in evaporating dish under inverted funnel.", "Plug funnel tip with cotton wool.", "Heat gently; the solid deposits on cool funnel walls."]
            },
            "simple_distillation": {
                name: "Simple Distillation",
                components: "Pure solvent from a Solution",
                removes: "Pure Solvent (Distillate) from Solutes",
                steps: ["Heat the solution in a flask with boiling chips.", "The solvent boils and turns into vapour.", "Vapour passes into a Liebig condenser.", "Condensed liquid is collected as distillate."]
            },
            "fractional_distillation": {
                name: "Fractional Distillation",
                components: "Miscible liquids with different boiling points",
                removes: "Liquids with lower boiling points first",
                steps: ["Heat mixture in a flask with fractionating column.", "Column provides surface area for repeated condensation.", "Liquid with lowest boiling point distills first.", "Other vapours condense and fall back into flask."]
            },
            "separating_funnel": {
                name: "Separating Funnel",
                components: "Immiscible liquids",
                removes: "The denser liquid (via the tap)",
                steps: ["Pour mixture into the separating funnel.", "Wait for distinct layers to form.", "Open tap to drain the denser bottom layer.", "Close tap before top layer reaches the opening."]
            },
            "paper_chromatography": {
                name: "Paper Chromatography",
                components: "Mixture of solutes with different solubilities",
                removes: "Individual components (separated on paper)",
                steps: ["Draw pencil start line on chromatography paper.", "Place a small spot of mixture on the line.", "Dip paper in solvent (below the line).", "Solutes travel up at different rates based on solubility."]
            }
        };

        const multiStepScenarios = [
            { id: 1, mixture: "Sand, Salt, and Iron filings", techniqueSequence: ["magnetic_attraction", "filtration", "evaporation"], pitfalls: { "filtration": "If you filter first, you'll still have iron and sand together. Magnetic attraction works best when the iron is dry!", "evaporation": "If you evaporate before filtering, the sand stays in the salt. Remove the insoluble sand first." }, sequenceHint: "Almost correct! Magnetic attraction should be first while the mixture is dry. If you add water to dissolve salt first, it becomes much harder to remove the iron with a magnet." },
            { id: 2, mixture: "Oil, Water, and Chalk powder", techniqueSequence: ["filtration", "separating_funnel"], pitfalls: { "separating_funnel": "Wait! If you use the funnel first, the chalk powder will clog the tap. Filter the solid out first.", "fractional_distillation": "Wait! Fractional distillation is for liquids that are MISCIBLE (mix together). Oil and water are IMMISCIBLE and form layers.", "simple_distillation": "Distillation is overkill. Oil and water form layers, so a funnel is faster and safer." }, sequenceHint: "The techniques are right, but the order is risky! Always filter the chalk powder first. If you use the separating funnel first, the chalk will settle at the bottom and clog the tap." },
            { id: 3, mixture: "Ammonium Chloride, Salt, and Sand", techniqueSequence: ["sublimation", "filtration", "evaporation"], pitfalls: { "filtration": "If you dissolve this now, both salt and ammonium chloride will go into solution. Sublime first to get pure crystals.", "magnetic_attraction": "None of these are magnetic (Iron, Nickel, Cobalt, Steel)." }, sequenceHint: "Correct set, but consider the solubility! Sublime the Ammonium Chloride first. If you add water first, you'll have two different soluble solids in the same liquid." },
            { id: 4, mixture: "Ethanol, Water, and Clay", techniqueSequence: ["filtration", "fractional_distillation"], pitfalls: { "separating_funnel": "Wait! Ethanol and Water are MISCIBLE. You won't see layers! A funnel only works for IMMISCIBLE liquids.", "simple_distillation": "Because Ethanol and Water have close boiling points, simple distillation won't work effectively. Use a column!" }, sequenceHint: "You've chosen the right tools, but order is key! You must filter the clay first. If you attempt distillation while the clay is still in the flask, it can cause uneven boiling or damage the equipment." },
            { id: 5, mixture: "Ink Dyes, Water, and Sand", techniqueSequence: ["filtration", "paper_chromatography"], pitfalls: { "paper_chromatography": "You can't do chromatography on a mixture containing sand! The sand will block the flow of solvent.", "evaporation": "Evaporation would destroy the dyes or leave a mess. Use chromatography to identify components." }, sequenceHint: "Filter the sand out first to obtain a clear ink solution. Once you have the liquid filtrate, you can proceed with Paper Chromatography." },
            { id: 6, mixture: "Muddy Seawater (aiming for pure water)", techniqueSequence: ["filtration", "simple_distillation"], pitfalls: { "evaporation": "Incorrect goal! Evaporation only leaves you with salt and mud. To get PURE WATER, you must condense the steam.", "separating_funnel": "Mud and water don't form immiscible layers like oil. Mud is an insoluble solid." }, sequenceHint: "First, use filtration to remove the insoluble mud. Once the filtrate is clear seawater, use Simple Distillation to collect the pure water solvent." },
            { id: 7, mixture: "Hexane, Water, and Table Salt", techniqueSequence: ["separating_funnel", "evaporation"], pitfalls: { "evaporation": "Danger! Hexane is highly flammable. You should never evaporate organic solvents near a Bunsen burner.", "fractional_distillation": "Hexane and Water are IMMISCIBLE. A funnel is much simpler and safer than distillation for immiscible liquids.", "filtration": "Hexane and Water are immiscible liquids. Filtration doesn't separate liquids." }, sequenceHint: "Use the Separating Funnel first to remove the layer of Hexane. Once the Hexane is gone, you are left with saltwater, which can be safely evaporated." },
            { id: 8, mixture: "Steel bits, Brass bits, and Sugar", techniqueSequence: ["magnetic_attraction", "filtration", "evaporation"], pitfalls: { "filtration": "Both Steel and Brass are insoluble solids. Filtering now won't separate them.", "sublimation": "None of these substances sublime. Sugar melts and caramelises when heated!" }, sequenceHint: "Use Magnetic Attraction first to remove the Steel. Then, add water to dissolve the sugar. Filter out the non-magnetic Brass bits, and finally evaporate the filtrate." }
        ];

        let state = {
            isQuizMode: false,
            currentQuizType: null,
            scores: { standard: 0, sequencing: 0, advanced: 0 },
            mastery: { standard: {}, sequencing: {}, advanced: {} },
            usedAdvancedIndices: [],
            currentAdvancedScenarioIndex: -1,
            isCheatsheetOpen: false
        };

        Object.keys(techniques).forEach(key => {
            state.mastery.standard[key] = 'untested';
            state.mastery.sequencing[key] = 'untested';
        });

        const mainContainer = document.getElementById('mainContainer');
        const modeToggle = document.getElementById('modeToggle');
        const toggleCircle = document.getElementById('toggleCircle');
        const scoreHeader = document.getElementById('scoreHeader');
        const standardScoreDisplay = document.getElementById('currentStandardScore');
        const sequencingScoreDisplay = document.getElementById('currentSequencingScore');
        const advancedScoreDisplay = document.getElementById('currentAdvancedScore');
        const standardChip = document.getElementById('standardScoreChip');
        const sequencingChip = document.getElementById('sequencingScoreChip');
        const advancedChip = document.getElementById('advancedScoreChip');
        const sidebar = document.getElementById('cheatsheetSidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const cheatsheetContent = document.getElementById('cheatsheetContent');

        function init() { populateCheatsheet(); renderStudyMode(); }

        function populateCheatsheet() {
            cheatsheetContent.innerHTML = Object.entries(techniques).map(([key, t]) => `
                <div class="border border-slate-100 rounded-lg overflow-hidden">
                    <button onclick="toggleAccordion('${key}')" class="w-full text-left p-3 bg-white hover:bg-slate-50 flex justify-between items-center transition-colors">
                        <span class="text-sm font-bold text-slate-700">${t.name}</span>
                        <svg id="icon-${key}" class="h-4 w-4 text-slate-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div id="acc-${key}" class="technique-accordion bg-slate-50 px-3 border-t border-slate-100">
                        <div class="py-3 text-xs space-y-3">
                            <div><p class="font-bold text-slate-500 uppercase tracking-tighter mb-1">Separates:</p><p class="text-slate-800">${t.components}</p></div>
                            <div><p class="font-bold text-slate-500 uppercase tracking-tighter mb-1">Mechanism:</p><p class="text-slate-800">${t.removes}</p></div>
                            <div><p class="font-bold text-slate-500 uppercase tracking-tighter mb-1">Steps:</p><ul class="list-disc pl-4 space-y-1 text-slate-600">${t.steps.map(s => `<li>${s}</li>`).join('')}</ul></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleAccordion(key) {
            const acc = document.getElementById(`acc-${key}`);
            const icon = document.getElementById(`icon-${key}`);
            const isOpen = acc.classList.contains('open');
            document.querySelectorAll('.technique-accordion').forEach(el => el.classList.remove('open'));
            document.querySelectorAll('.technique-accordion button svg').forEach(el => el.style.transform = 'rotate(0deg)');
            if (!isOpen) { acc.classList.add('open'); icon.style.transform = 'rotate(180deg)'; }
        }

        function toggleCheatsheet() {
            state.isCheatsheetOpen = !state.isCheatsheetOpen;
            sidebar.classList.toggle('sidebar-closed', !state.isCheatsheetOpen);
            sidebar.classList.toggle('sidebar-open', state.isCheatsheetOpen);
        }

        modeToggle.addEventListener('click', () => {
            state.isQuizMode = !state.isQuizMode;
            state.isCheatsheetOpen = false;
            sidebar.classList.replace('sidebar-open', 'sidebar-closed');
            if (state.isQuizMode) {
                toggleCircle.classList.replace('translate-x-0', 'translate-x-5');
                modeToggle.classList.replace('bg-slate-200', 'bg-blue-600');
                scoreHeader.classList.remove('hidden');
                sidebarToggle.classList.remove('hidden');
                updateScoreDisplays();
                renderQuizMenu();
            } else {
                toggleCircle.classList.replace('translate-x-5', 'translate-x-0');
                modeToggle.classList.replace('bg-blue-600', 'bg-slate-200');
                scoreHeader.classList.add('hidden');
                sidebarToggle.classList.add('hidden');
                renderStudyMode();
            }
        });

        function calculateScore(type) {
            if (type === 'advanced') return Object.keys(state.mastery.advanced).length;
            return Object.values(state.mastery[type]).filter(s => s === 'correct').length; 
        }

        function updateScoreDisplays() { 
            standardScoreDisplay.textContent = `${calculateScore('standard')}/8`; 
            sequencingScoreDisplay.textContent = `${calculateScore('sequencing')}/8`; 
            advancedScoreDisplay.textContent = `${calculateScore('advanced')}/8`;
        }

        function resetAllProgress() { 
            Object.keys(techniques).forEach(key => { state.mastery.standard[key] = 'untested'; state.mastery.sequencing[key] = 'untested'; }); 
            state.mastery.advanced = {};
            state.usedAdvancedIndices = []; 
            updateScoreDisplays(); renderQuizMenu(); 
        }

        function renderStudyMode() {
            mainContainer.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">${Object.entries(techniques).map(([key, t]) => `<div class="glass-card p-6 border-l-4 border-l-blue-500"><h3 class="text-xl font-bold text-blue-700 mb-2">${t.name}</h3><div class="mb-4"><span class="text-xs font-bold uppercase tracking-wider text-slate-400">Separates:</span><p class="text-slate-700 font-semibold">${t.components}</p></div><div class="mb-4 bg-blue-50 p-3 rounded-lg"><span class="text-xs font-bold uppercase tracking-wider text-blue-400">Mechanism:</span><p class="text-sm text-blue-800">${t.removes}</p></div><div><span class="text-xs font-bold uppercase tracking-wider text-slate-400">Steps:</span><ol class="mt-2 space-y-2">${t.steps.map((step, i) => `<li class="flex items-start text-sm text-slate-600"><span class="flex-shrink-0 w-5 h-5 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold mr-2 mt-0.5">${i+1}</span>${step}</li>`).join('')}</ol></div></div>`).join('')}</div>`;
        }

        function renderQuizMenu() {
            state.currentQuizType = null; updateScoreChips();
            mainContainer.innerHTML = `<div class="glass-card p-8 text-center max-w-lg mx-auto"><h2 class="text-2xl font-bold mb-6">Select Quiz Challenge</h2><div class="space-y-4"><button onclick="startStandardQuiz()" class="w-full py-4 px-6 bg-white border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 rounded-xl font-semibold transition-all">ðŸŽ¯ Standard Identification</button><button onclick="startSequencingQuiz()" class="w-full py-4 px-6 bg-white border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 rounded-xl font-semibold transition-all">ðŸ§© Reorder Steps</button><button onclick="startAdvancedQuiz()" class="w-full py-4 px-6 bg-white border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 rounded-xl font-semibold transition-all">ðŸš€ Multi-step Lab Plan</button></div></div>`;
        }

        // Standard quiz functions
        function startStandardQuiz() {
            state.currentQuizType = 'standard'; updateScoreChips();
            const keys = Object.keys(techniques); const randomKey = keys[Math.floor(Math.random() * keys.length)]; const current = techniques[randomKey]; const isIdentifyingTechnique = Math.random() > 0.5;
            let question, options, correct;
            if (isIdentifyingTechnique) { question = `Which technique is used to separate <strong>${current.components}</strong>?`; correct = current.name; options = shuffle([...new Set(keys.map(k => techniques[k].name))]).slice(0, 3); if (!options.includes(correct)) options[0] = correct; }
            else { question = `What does <strong>${current.name}</strong> primarily separate?`; correct = current.components; options = shuffle([...new Set(keys.map(k => techniques[k].components))]).slice(0, 3); if (!options.includes(correct)) options[0] = correct; }
            mainContainer.innerHTML = `<div class="glass-card p-8 max-w-2xl mx-auto"><div class="flex justify-between items-center mb-6"><span class="text-sm font-bold text-blue-600 uppercase tracking-widest">Standard Identification</span><button onclick="renderQuizMenu()" class="text-xs text-slate-400 hover:text-slate-600">Back to Menu</button></div><p class="text-lg mb-8 text-slate-800">${question}</p><div class="grid grid-cols-1 gap-4">${shuffle(options).map(opt => `<button onclick="checkStandardAnswer(this, '${opt}', '${correct}', '${randomKey}')" class="option-btn p-4 border-2 border-slate-100 rounded-xl text-left hover:bg-slate-50 transition-all font-medium">${opt}</button>`).join('')}</div><div id="feedback" class="mt-6 hidden p-4 rounded-lg font-semibold text-center"></div>${getTechniqueTrackerHtml('standard')}</div>`;
        }
        function checkStandardAnswer(btn, selected, correct, techKey) {
            const btns = document.querySelectorAll('.option-btn'); btns.forEach(b => b.disabled = true); const feedback = document.getElementById('feedback'); feedback.classList.remove('hidden');
            if (selected === correct) { btn.classList.add('correct'); feedback.textContent = "Correct!"; feedback.className = "mt-6 p-4 rounded-lg font-semibold text-center bg-green-100 text-green-800"; state.mastery.standard[techKey] = 'correct'; }
            else { btn.classList.add('incorrect'); feedback.textContent = `Incorrect. It's ${correct}`; feedback.className = "mt-6 p-4 rounded-lg font-semibold text-center bg-red-100 text-red-800"; state.mastery.standard[techKey] = 'incorrect'; }
            updateScoreDisplays(); setTimeout(startStandardQuiz, 1500);
        }

        // Sequencing quiz functions
        function startSequencingQuiz() {
            state.currentQuizType = 'sequencing'; updateScoreChips();
            const keys = Object.keys(techniques); const randomKey = keys[Math.floor(Math.random() * keys.length)]; const current = techniques[randomKey]; const jumbled = shuffle([...current.steps]);
            mainContainer.innerHTML = `<div class="glass-card p-8 max-w-2xl mx-auto"><div class="flex justify-between items-center mb-6"><span class="text-sm font-bold text-purple-600 uppercase tracking-widest">Sequencing Challenge</span><button onclick="renderQuizMenu()" class="text-xs text-slate-400 hover:text-slate-600">Back to Menu</button></div><h3 class="text-xl font-bold text-slate-800 mb-2">${current.name}</h3><p class="text-sm text-slate-500 mb-6">Drag steps into order:</p><div id="sortableList" class="space-y-3 mb-8">${jumbled.map(step => `<div draggable="true" class="step-item p-4 bg-slate-50 border border-slate-200 rounded-lg text-sm flex items-center group" data-step="${step}"><span class="mr-4 text-slate-300 group-hover:text-slate-500">â˜°</span>${step}</div>`).join('')}</div><button onclick="checkSequence('${randomKey}')" class="w-full py-3 bg-purple-600 text-white font-bold rounded-xl shadow-lg hover:bg-purple-700 transition-all">Verify Sequence</button><div id="feedback" class="mt-6 hidden p-4 rounded-lg font-semibold text-center"></div>${getTechniqueTrackerHtml('sequencing')}</div>`;
            initDraggable();
        }
        function checkSequence(key) {
            const items = document.querySelectorAll('.step-item'); const currentOrder = Array.from(items).map(i => i.getAttribute('data-step')); const correctOrder = techniques[key].steps; const feedback = document.getElementById('feedback'); feedback.classList.remove('hidden'); let isCorrect = true;
            items.forEach((item, index) => { if (currentOrder[index] === correctOrder[index]) item.className = "step-item p-4 border rounded-lg text-sm flex items-center correct"; else { item.className = "step-item p-4 border rounded-lg text-sm flex items-center incorrect"; isCorrect = false; } });
            if (isCorrect) { feedback.textContent = "Correct Sequence!"; feedback.className = "mt-6 p-4 rounded-lg font-semibold text-center bg-green-100 text-green-800"; state.mastery.sequencing[key] = 'correct'; updateScoreDisplays(); setTimeout(startSequencingQuiz, 2000); }
            else { feedback.textContent = "Incorrect order. Try again!"; feedback.className = "mt-6 p-4 rounded-lg font-semibold text-center bg-red-100 text-red-800"; state.mastery.sequencing[key] = 'incorrect'; updateScoreDisplays(); }
        }

        // Advanced Multi-step functions
        function startAdvancedQuiz() {
            state.currentQuizType = 'advanced'; updateScoreChips();
            if (state.usedAdvancedIndices.length === multiStepScenarios.length) state.usedAdvancedIndices = [];
            let availableIndices = multiStepScenarios.map((_, i) => i).filter(i => !state.usedAdvancedIndices.includes(i));
            let randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
            state.usedAdvancedIndices.push(randomIndex); state.currentAdvancedScenarioIndex = randomIndex;
            renderAdvancedScenario(multiStepScenarios[randomIndex]);
        }

        function renderAdvancedScenario(scenario) {
            const allTechniques = Object.keys(techniques);
            mainContainer.innerHTML = `
                <div class="glass-card p-8 max-w-3xl mx-auto">
                    <div class="flex justify-between items-center mb-6"><span class="text-sm font-bold text-orange-600 uppercase tracking-widest">Multi-Step Lab Plan</span><button onclick="renderQuizMenu()" class="text-xs text-slate-400 hover:text-slate-600">Back to Menu</button></div>
                    <div class="bg-orange-50 p-6 rounded-xl mb-8"><h4 class="font-bold text-orange-800 mb-2 text-sm uppercase">Mixture to Separate:</h4><p class="text-2xl font-black text-orange-900">${scenario.mixture}</p></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div><p class="text-xs font-bold text-slate-400 uppercase mb-4">Available Techniques</p><div class="flex flex-wrap gap-2">${shuffle(allTechniques).map(k => `<div draggable="true" class="tech-tag px-3 py-2 bg-white border border-slate-200 rounded-md text-[10px] font-semibold cursor-grab hover:shadow-sm" data-key="${k}">${techniques[k].name}</div>`).join('')}</div></div>
                        <div><p class="text-xs font-bold text-slate-400 uppercase mb-4">Your Plan</p><div id="planZones" class="space-y-4">${scenario.techniqueSequence.map((_, i) => `<div class="drop-zone flex items-center justify-center text-[10px] text-slate-400 font-bold" data-index="${i}">DROP STEP ${i+1} HERE</div>`).join('')}</div></div>
                    </div>
                    <div id="advancedControls" class="mt-8 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                        <button onclick="checkAdvancedPlan()" class="flex-grow py-4 bg-slate-800 text-white font-bold rounded-xl shadow-lg hover:bg-black transition-all">Execute Plan</button>
                        <button onclick="clearAllAdvancedSteps()" class="px-6 py-4 bg-white border-2 border-slate-200 text-slate-600 font-bold rounded-xl hover:border-red-500 hover:text-red-500 transition-all text-sm uppercase tracking-wider">Clear All</button>
                    </div>
                    <div id="feedback" class="mt-6 hidden p-6 rounded-xl font-medium flex flex-col"></div>
                </div>
            `;
            initAdvancedDraggable();
        }

        function clearAllAdvancedSteps() {
            const zones = document.querySelectorAll('.drop-zone');
            zones.forEach(zone => { zone.innerHTML = `DROP STEP ${parseInt(zone.getAttribute('data-index')) + 1} HERE`; });
            document.getElementById('feedback').classList.add('hidden');
        }

        function checkAdvancedPlan() {
            const scenario = multiStepScenarios[state.currentAdvancedScenarioIndex];
            const zones = document.querySelectorAll('.drop-zone');
            const feedback = document.getElementById('feedback'); feedback.classList.remove('hidden');
            let userSequence = []; let allFilled = true;
            zones.forEach(z => { const child = z.querySelector('.tech-tag'); if (child) userSequence.push(child.getAttribute('data-key')); else allFilled = false; });
            if (!allFilled) { feedback.innerHTML = `<p class="text-center font-bold text-yellow-800">Fill all steps before executing.</p>`; feedback.className = "mt-6 p-4 rounded-lg bg-yellow-100"; return; }
            
            let isCorrect = userSequence.every((val, index) => val === scenario.techniqueSequence[index]);
            let hasCorrectSet = [...userSequence].sort().join(',') === [...scenario.techniqueSequence].sort().join(',');

            if (isCorrect) {
                feedback.className = "mt-6 p-6 rounded-xl bg-green-50 border border-green-200 text-green-900";
                let breakdown = `<h5 class="font-bold text-lg mb-4 text-center">Plan Successful!</h5><div class="space-y-4 w-full text-sm">`;
                scenario.techniqueSequence.forEach((key, i) => { breakdown += `<div class="flex items-center space-x-4 bg-white p-3 rounded-lg border border-green-100 shadow-sm"><span class="w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center font-bold text-xs">${i+1}</span><div><p class="font-bold">${techniques[key].name}</p><p class="text-xs text-green-700">Removes: ${techniques[key].removes}</p></div></div>`; });
                breakdown += `</div><button onclick="startAdvancedQuiz()" class="mt-6 w-full py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-all shadow-md">Next Mixture</button>`;
                feedback.innerHTML = breakdown; 
                document.getElementById('advancedControls').classList.add('hidden');
                
                // Track mastery for advanced
                state.mastery.advanced[scenario.id] = 'correct';
                updateScoreDisplays();
            } else {
                feedback.className = "mt-6 p-6 rounded-xl bg-red-50 border border-red-200 text-red-900";
                let guidanceText = "Plan failed.";
                if (hasCorrectSet) {
                    guidanceText = `<div class="hint-box p-4 rounded-lg mb-4"><p class="text-xs font-bold text-amber-600 uppercase tracking-widest mb-1">Sequence Insight:</p><p class="text-sm italic text-amber-900 font-semibold">"${scenario.sequenceHint}"</p></div>`;
                } else {
                    const firstWrongIndex = userSequence.findIndex((val, index) => val !== scenario.techniqueSequence[index]);
                    const wrongTech = userSequence[firstWrongIndex];
                    guidanceText = (scenario.pitfalls && scenario.pitfalls[wrongTech]) ? `<div class="hint-box p-4 rounded-lg mb-4"><p class="text-xs font-bold text-amber-600 uppercase tracking-widest mb-1">Guidance:</p><p class="text-sm italic text-amber-900 font-semibold">"${scenario.pitfalls[wrongTech]}"</p></div>` : `<p class="font-bold mb-4">Plan failed at Step ${firstWrongIndex + 1}.</p>`;
                }
                feedback.innerHTML = `${guidanceText}<div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4"><button onclick="retryAdvancedScenario()" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-all text-sm">Retry Mixture</button><button onclick="startAdvancedQuiz()" class="px-6 py-2 bg-white border border-red-200 text-red-600 font-bold rounded-lg hover:bg-red-50 transition-all text-sm">Different Mixture</button></div>`;
            }
        }

        function retryAdvancedScenario() { if (state.currentAdvancedScenarioIndex !== -1) renderAdvancedScenario(multiStepScenarios[state.currentAdvancedScenarioIndex]); }
        function shuffle(array) { return array.sort(() => Math.random() - 0.5); }
        
        function initDraggable() {
            const list = document.getElementById('sortableList'); let draggingItem = null;
            list.addEventListener('dragstart', (e) => { draggingItem = e.target; e.target.classList.add('dragging'); });
            list.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
            list.addEventListener('dragover', (e) => { e.preventDefault(); const afterElement = getDragAfterElement(list, e.clientY); if (afterElement == null) list.appendChild(draggingItem); else list.insertBefore(draggingItem, afterElement); });
        }

        function initAdvancedDraggable() {
            const tags = document.querySelectorAll('.tech-tag'); const zones = document.querySelectorAll('.drop-zone'); let draggedTag = null;
            tags.forEach(tag => {
                tag.addEventListener('dragstart', (e) => { draggedTag = tag; setTimeout(() => tag.classList.add('opacity-50'), 0); });
                tag.addEventListener('dragend', () => tag.classList.remove('opacity-50'));
            });
            zones.forEach(zone => {
                zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
                zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
                zone.addEventListener('drop', (e) => {
                    e.preventDefault(); zone.classList.remove('drag-over');
                    const clone = draggedTag.cloneNode(true);
                    clone.classList.remove('cursor-grab'); clone.classList.add('cursor-pointer');
                    clone.onclick = () => zone.innerHTML = `DROP STEP ${parseInt(zone.getAttribute('data-index'))+1} HERE`; 
                    zone.innerHTML = ""; zone.appendChild(clone);
                });
            });
        }

        function getDragAfterElement(container, y) { const draggableElements = [...container.querySelectorAll('.step-item:not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest; }, { offset: Number.NEGATIVE_INFINITY }).element; }
        function getTechniqueTrackerHtml(type) { const masterySet = state.mastery[type]; return `<div class="mt-10 pt-6 border-t border-slate-200"><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4 text-center">${type} mastery tracker</p><div class="flex flex-wrap justify-center gap-2">${Object.entries(techniques).map(([key, t]) => { const status = masterySet[key]; let statusClass = "status-untested"; if (status === 'correct') statusClass = "status-correct"; if (status === 'incorrect') statusClass = "status-incorrect"; return `<div class="px-2 py-1 rounded text-[9px] font-bold uppercase ${statusClass}">${t.name}</div>`; }).join('')}</div></div>`; }
        
        function updateScoreChips() { 
            if (!state.isQuizMode) return; 
            standardChip.classList.toggle('opacity-100', state.currentQuizType === 'standard'); standardChip.classList.toggle('opacity-30', state.currentQuizType !== 'standard'); 
            sequencingChip.classList.toggle('opacity-100', state.currentQuizType === 'sequencing'); sequencingChip.classList.toggle('opacity-30', state.currentQuizType !== 'sequencing'); 
            advancedChip.classList.toggle('opacity-100', state.currentQuizType === 'advanced'); advancedChip.classList.toggle('opacity-30', state.currentQuizType !== 'advanced'); 
        }
        window.onload = init;
    </script>
</body>
</html>
